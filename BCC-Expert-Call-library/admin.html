<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMind ç®¡ç†å·¥å…·</title>
  <style>
    body { font-family: -apple-system, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background: #f8fafc; }
    h1 { color: #2d6ad1; }
    .card { background: white; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .result { padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 14px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #e2e3e5; color: #383d41; }
    .warning { background: #fff3cd; color: #856404; }
    button { padding: 10px 20px; font-size: 14px; cursor: pointer; margin: 5px; border: none; border-radius: 8px; }
    .btn-primary { background: #2d6ad1; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    input { padding: 10px; width: 100%; font-size: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; overflow-x: auto; font-size: 12px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f1f5f9; }
    .record-row:hover { background: #f8fafc; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-back { background: #2d6ad1; color: white; text-decoration: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; }
    .btn-back:hover { background: #1d5abc; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ› ï¸ DocuMind ç®¡ç†å·¥å…·</h1>
    <a href="./" class="btn-back">â† è¿”å›ä¸»é¡µ</a>
  </div>

  <!-- Supabase é…ç½® -->
  <div class="card">
    <h3>ğŸ“‹ Supabase é…ç½®</h3>
    <div id="config-info"></div>
  </div>

  <!-- æ•°æ®åº“è®°å½•ç®¡ç† -->
  <div class="card">
    <h3>ğŸ“š æ•°æ®åº“è®°å½•ç®¡ç†</h3>
    <button class="btn-primary" onclick="loadRecords()">åˆ·æ–°åˆ—è¡¨</button>
    <button class="btn-danger" onclick="deleteAllRecords()">âš ï¸ åˆ é™¤æ‰€æœ‰è®°å½•</button>
    <div id="records-list"></div>
  </div>

  <!-- Edge Function æµ‹è¯• -->
  <div class="card">
    <h3>ğŸ§ª Edge Function æµ‹è¯•</h3>
    <input type="text" id="apiKey" placeholder="è¾“å…¥ Gemini API Key (AIzaSy...)">
    <button class="btn-primary" onclick="testGeminiDirect()">æµ‹è¯• Gemini ç›´è¿</button>
    <button class="btn-secondary" onclick="testEdgeFunction()">æµ‹è¯• Edge Function</button>
    <div id="test-results"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://rybiwfmmnauzypkrtafs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5Yml3Zm1tbmF1enlwa3J0YWZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzU3MTUsImV4cCI6MjA4NTE1MTcxNX0.qb7FUvCjzojTQ5RNY-a3lCarhkV3Lf2c90hQ5Mhd79Y';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
    document.getElementById('config-info').innerHTML = `
      <div class="result info">
        <strong>URL:</strong> ${SUPABASE_URL}<br>
        <strong>Anon Key:</strong> ${SUPABASE_ANON_KEY.substring(0, 30)}...
      </div>
    `;

    // åŠ è½½è®°å½•
    window.loadRecords = async function() {
      const container = document.getElementById('records-list');
      container.innerHTML = '<div class="result info">åŠ è½½ä¸­...</div>';

      try {
        const { data, error } = await supabase
          .from('expert_calls')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="result warning">æ•°æ®åº“ä¸­æ²¡æœ‰è®°å½•</div>';
          return;
        }

        let html = `<div class="result success">å…± ${data.length} æ¡è®°å½•</div>`;
        html += `<table>
          <tr><th>æ ‡é¢˜</th><th>ID</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr>`;
        
        for (const record of data) {
          html += `<tr class="record-row">
            <td>${record.title || 'æ— æ ‡é¢˜'}</td>
            <td><code>${record.id.substring(0, 8)}...</code></td>
            <td>${new Date(record.created_at).toLocaleString()}</td>
            <td><button class="btn-danger" onclick="deleteRecord('${record.id}')">åˆ é™¤</button></td>
          </tr>`;
        }
        html += '</table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="result error">é”™è¯¯: ${err.message}</div>`;
      }
    };

    // åˆ é™¤å•æ¡è®°å½•
    window.deleteRecord = async function(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;

      try {
        // å…ˆè·å–è®°å½•æŸ¥çœ‹æ˜¯å¦æœ‰å›¾ç‰‡éœ€è¦åˆ é™¤
        const { data: record } = await supabase
          .from('expert_calls')
          .select('thumbnail_url, full_image_url')
          .eq('id', id)
          .single();

        // åˆ é™¤ Storage ä¸­çš„å›¾ç‰‡
        if (record) {
          const filesToDelete = [];
          if (record.thumbnail_url && record.thumbnail_url.includes('expert-images')) {
            const match = record.thumbnail_url.match(/expert-images\/(.+)$/);
            if (match) filesToDelete.push(match[1]);
          }
          if (record.full_image_url && record.full_image_url.includes('expert-images')) {
            const match = record.full_image_url.match(/expert-images\/(.+)$/);
            if (match) filesToDelete.push(match[1]);
          }
          if (filesToDelete.length > 0) {
            await supabase.storage.from('expert-images').remove(filesToDelete);
          }
        }

        // åˆ é™¤æ•°æ®åº“è®°å½•
        const { error } = await supabase
          .from('expert_calls')
          .delete()
          .eq('id', id);

        if (error) throw error;
        
        alert('åˆ é™¤æˆåŠŸï¼');
        loadRecords();
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
      }
    };

    // åˆ é™¤æ‰€æœ‰è®°å½•
    window.deleteAllRecords = async function() {
      if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;

      try {
        // è·å–æ‰€æœ‰è®°å½•
        const { data: records } = await supabase
          .from('expert_calls')
          .select('id, thumbnail_url, full_image_url');

        // æ”¶é›†æ‰€æœ‰å›¾ç‰‡è·¯å¾„
        const filesToDelete = [];
        for (const record of records || []) {
          if (record.thumbnail_url && record.thumbnail_url.includes('expert-images')) {
            const match = record.thumbnail_url.match(/expert-images\/(.+)$/);
            if (match) filesToDelete.push(match[1]);
          }
          if (record.full_image_url && record.full_image_url.includes('expert-images')) {
            const match = record.full_image_url.match(/expert-images\/(.+)$/);
            if (match) filesToDelete.push(match[1]);
          }
        }

        // åˆ é™¤æ‰€æœ‰å›¾ç‰‡
        if (filesToDelete.length > 0) {
          await supabase.storage.from('expert-images').remove(filesToDelete);
        }

        // åˆ é™¤æ‰€æœ‰æ•°æ®åº“è®°å½•
        const { error } = await supabase
          .from('expert_calls')
          .delete()
          .neq('id', '00000000-0000-0000-0000-000000000000'); // åˆ é™¤æ‰€æœ‰

        if (error) throw error;

        alert('æ‰€æœ‰è®°å½•å·²åˆ é™¤ï¼');
        loadRecords();
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
      }
    };

    // æµ‹è¯• Gemini ç›´è¿
    window.testGeminiDirect = async function() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const container = document.getElementById('test-results');
      
      if (!apiKey) {
        container.innerHTML = '<div class="result error">è¯·è¾“å…¥ API Key</div>';
        return;
      }

      container.innerHTML = '<div class="result info">æµ‹è¯•ä¸­...</div>';

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: 'Say hello in Chinese, keep it short.' }] }]
            })
          }
        );

        const data = await response.json();
        
        if (response.ok) {
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
          container.innerHTML = `<div class="result success">âœ… Gemini ç›´è¿æˆåŠŸï¼<br>å“åº”: ${text}</div>`;
        } else {
          container.innerHTML = `<div class="result error">âŒ é”™è¯¯ (${response.status})<pre>${JSON.stringify(data, null, 2)}</pre></div>`;
        }
      } catch (err) {
        container.innerHTML = `<div class="result error">âŒ ç½‘ç»œé”™è¯¯: ${err.message}</div>`;
      }
    };

    // æµ‹è¯• Edge Function
    window.testEdgeFunction = async function() {
      const container = document.getElementById('test-results');
      container.innerHTML = '<div class="result info">æµ‹è¯• Edge Function...</div>';

      try {
        const { data, error } = await supabase.functions.invoke('gemini-proxy', {
          body: {
            action: 'query',
            prompt: 'Say hello',
            context: '<document>Test document</document>'
          }
        });

        if (error) {
          container.innerHTML = `<div class="result error">âŒ Edge Function é”™è¯¯<pre>${JSON.stringify(error, null, 2)}</pre></div>`;
        } else {
          container.innerHTML = `<div class="result success">âœ… Edge Function æˆåŠŸï¼<pre>${JSON.stringify(data, null, 2)}</pre></div>`;
        }
      } catch (err) {
        container.innerHTML = `<div class="result error">âŒ é”™è¯¯: ${err.message}</div>`;
      }
    };

    // åˆå§‹åŠ è½½
    loadRecords();
  </script>
</body>
</html>
